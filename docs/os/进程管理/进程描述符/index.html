<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=Linux内核><meta name=author content=mestarz><link href=https://mestarz.github.io/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E8%BF%9B%E7%A8%8B%E6%8F%8F%E8%BF%B0%E7%AC%A6/ rel=canonical><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.8"><title>进程描述符 - Linux内核</title><link rel=stylesheet href=../../assets/stylesheets/main.cb6bc1d0.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.39b8e14a.min.css><meta name=theme-color content=#ffffff><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback"><style>body,input{font-family:"Noto Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../../static/css/extra.css></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=white data-md-color-accent=red> <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://mestarz.github.io/ title=Linux内核 class="md-header-nav__button md-logo" aria-label=Linux内核> <img src=../../static/img/logo.png alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <div class=md-header-nav__topic> <span class=md-ellipsis> Linux内核 </span> </div> <div class=md-header-nav__topic> <span class=md-ellipsis> 进程描述符 </span> </div> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/mestarz/mestarz-os/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> mestarz/mestarz-os </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> 介绍 </a> </li> <li class=md-tabs__item> <a href=../../%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8/ class=md-tabs__link> 内核调试 </a> </li> <li class=md-tabs__item> <a href=../%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/ class="md-tabs__link md-tabs__link--active"> 进程管理 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://mestarz.github.io/ title=Linux内核 class="md-nav__button md-logo" aria-label=Linux内核> <img src=../../static/img/logo.png alt=logo> </a> Linux内核 </label> <div class=md-nav__source> <a href=https://github.com/mestarz/mestarz-os/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> mestarz/mestarz-os </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> 介绍 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=介绍 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> 介绍 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Welcome to MkDocs </a> </li> <li class=md-nav__item> <a href=../../%E4%BB%8B%E7%BB%8D/%E5%86%85%E6%A0%B8%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D/ class=md-nav__link> 内核结构介绍 </a> </li> <li class=md-nav__item> <a href=../../%E4%BB%8B%E7%BB%8D/%E6%BA%90%E7%A0%81%E6%B5%8F%E8%A7%88%E6%96%B9%E6%B3%95/ class=md-nav__link> 源码浏览方法 </a> </li> <li class=md-nav__item> <a href=../../%E4%BB%8B%E7%BB%8D/%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D/ class=md-nav__link> 相关工具介绍 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> 内核调试 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=内核调试 data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> 内核调试 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8/ class=md-nav__link> 编译内核 </a> </li> <li class=md-nav__item> <a href=../../%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/%E4%BD%BF%E7%94%A8QEMU%E8%BF%90%E8%A1%8C%E5%86%85%E6%A0%B8/ class=md-nav__link> 使用QEMU运行内核 </a> </li> <li class=md-nav__item> <a href=../../%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/%E4%BD%BF%E7%94%A8GDB%E8%B0%83%E8%AF%95%E5%86%85%E6%A0%B8/ class=md-nav__link> 使用GDB调试内核 </a> </li> <li class=md-nav__item> <a href=../../%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/%E4%BD%BF%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E8%BF%90%E8%A1%8C%E5%86%85%E6%A0%B8/ class=md-nav__link> 使用树莓派运行内核 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3 checked> <label class=md-nav__link for=nav-3> 进程管理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=进程管理 data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> 进程管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/ class=md-nav__link> 进程生命周期 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 进程描述符 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 进程描述符 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1 进程描述符的结构 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2 进程描述符的存放 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81/ class=md-nav__link> 进程状态 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1 进程描述符的结构 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2 进程描述符的存放 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/mestarz/mestarz-os/edit/master/docs/进程管理/进程描述符.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>进程描述符</h1> <h3 id=1>1 进程描述符的结构<a class=headerlink href=#1 title="Permanent link">&para;</a></h3> <p>内核把进程的列表存放在叫做任务队列（task list）的双向循环链表中。链表中的每一项都是类型为<strong>task_struct</strong>的进程描述符结构，该结构定义在<linux sched.h>文件中（./include/linux/sched.h)。进程描述符包含了一个具体进程的所有信息。 <div class=highlight><pre><span></span><code><span class=k>struct</span> <span class=nc>task_struct</span> <span class=p>{</span>
    <span class=k>volatile</span> <span class=kt>long</span> <span class=n>state</span><span class=p>;</span>    <span class=cm>/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>stack</span><span class=p>;</span>
    <span class=n>atomic_t</span> <span class=n>usage</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>;</span> <span class=cm>/* per process flags, defined below */</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>ptrace</span><span class=p>;</span>

    <span class=kt>int</span> <span class=n>lock_depth</span><span class=p>;</span>     <span class=cm>/* BKL lock depth */</span>

<span class=cp>#ifdef CONFIG_SMP</span>
<span class=cp>#ifdef __ARCH_WANT_UNLOCKED_CTXSW</span>
    <span class=kt>int</span> <span class=n>oncpu</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#endif</span>

    <span class=kt>int</span> <span class=n>prio</span><span class=p>,</span> <span class=n>static_prio</span><span class=p>,</span> <span class=n>normal_prio</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>rt_priority</span><span class=p>;</span>
    <span class=k>const</span> <span class=k>struct</span> <span class=nc>sched_class</span> <span class=o>*</span><span class=n>sched_class</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>sched_entity</span> <span class=n>se</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>sched_rt_entity</span> <span class=n>rt</span><span class=p>;</span>

<span class=cp>#ifdef CONFIG_PREEMPT_NOTIFIERS</span>
    <span class=cm>/* list of struct preempt_notifier: */</span>
    <span class=k>struct</span> <span class=nc>hlist_head</span> <span class=n>preempt_notifiers</span><span class=p>;</span>
<span class=cp>#endif</span>

    <span class=cm>/*</span>
<span class=cm>     * fpu_counter contains the number of consecutive context switches</span>
<span class=cm>     * that the FPU is used. If this is over a threshold, the lazy fpu</span>
<span class=cm>     * saving becomes unlazy to save the trap. This is an unsigned char</span>
<span class=cm>     * so that after 256 times the counter wraps and the behavior turns</span>
<span class=cm>     * lazy again; this to deal with bursty apps that only use FPU for</span>
<span class=cm>     * a short time</span>
<span class=cm>     */</span>
    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>fpu_counter</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_BLK_DEV_IO_TRACE</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>btrace_seq</span><span class=p>;</span>
<span class=cp>#endif</span>

    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>policy</span><span class=p>;</span>
    <span class=kt>cpumask_t</span> <span class=n>cpus_allowed</span><span class=p>;</span>

<span class=cp>#ifdef CONFIG_TREE_PREEMPT_RCU</span>
    <span class=kt>int</span> <span class=n>rcu_read_lock_nesting</span><span class=p>;</span>
    <span class=kt>char</span> <span class=n>rcu_read_unlock_special</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>rcu_node</span> <span class=o>*</span><span class=n>rcu_blocked_node</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>rcu_node_entry</span><span class=p>;</span>
<span class=cp>#endif </span><span class=cm>/* #ifdef CONFIG_TREE_PREEMPT_RCU */</span><span class=cp></span>

<span class=cp>#if defined(CONFIG_SCHEDSTATS) || defined(CONFIG_TASK_DELAY_ACCT)</span>
    <span class=k>struct</span> <span class=nc>sched_info</span> <span class=n>sched_info</span><span class=p>;</span>
<span class=cp>#endif</span>

    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>tasks</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>plist_node</span> <span class=n>pushable_tasks</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>mm_struct</span> <span class=o>*</span><span class=n>mm</span><span class=p>,</span> <span class=o>*</span><span class=n>active_mm</span><span class=p>;</span>
<span class=cp>#if defined(SPLIT_RSS_COUNTING)</span>
    <span class=k>struct</span> <span class=nc>task_rss_stat</span>    <span class=n>rss_stat</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cm>/* task state */</span>
    <span class=kt>int</span> <span class=n>exit_state</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>exit_code</span><span class=p>,</span> <span class=n>exit_signal</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>pdeath_signal</span><span class=p>;</span>  <span class=cm>/*  The signal sent when the parent dies  */</span>
    <span class=cm>/* ??? */</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>personality</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=nl>did_exec</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=nl>in_execve</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>   <span class=cm>/* Tell the LSMs that the process is doing an</span>
<span class=cm>                 * execve */</span>
    <span class=kt>unsigned</span> <span class=nl>in_iowait</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>


    <span class=cm>/* Revert to default priority/policy when forking */</span>
    <span class=kt>unsigned</span> <span class=nl>sched_reset_on_fork</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>

    <span class=kt>pid_t</span> <span class=n>pid</span><span class=p>;</span>
    <span class=kt>pid_t</span> <span class=n>tgid</span><span class=p>;</span>

<span class=cp>#ifdef CONFIG_CC_STACKPROTECTOR</span>
    <span class=cm>/* Canary value for the -fstack-protector gcc feature */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>stack_canary</span><span class=p>;</span>
<span class=cp>#endif</span>

    <span class=cm>/* </span>
<span class=cm>     * pointers to (original) parent process, youngest child, younger sibling,</span>
<span class=cm>     * older sibling, respectively.  (p-&gt;father can be replaced with </span>
<span class=cm>     * p-&gt;real_parent-&gt;pid)</span>
<span class=cm>     */</span>
    <span class=k>struct</span> <span class=nc>task_struct</span> <span class=o>*</span><span class=n>real_parent</span><span class=p>;</span> <span class=cm>/* real parent process */</span>
    <span class=k>struct</span> <span class=nc>task_struct</span> <span class=o>*</span><span class=n>parent</span><span class=p>;</span> <span class=cm>/* recipient of SIGCHLD, wait4() reports */</span>
    <span class=cm>/*</span>
<span class=cm>     * children/sibling forms the list of my natural children</span>
<span class=cm>     */</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>children</span><span class=p>;</span>  <span class=cm>/* list of my children */</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>sibling</span><span class=p>;</span>   <span class=cm>/* linkage in my parent&#39;s children list */</span>
    <span class=k>struct</span> <span class=nc>task_struct</span> <span class=o>*</span><span class=n>group_leader</span><span class=p>;</span>   <span class=cm>/* threadgroup leader */</span>

    <span class=cm>/*</span>
<span class=cm>     * ptraced is the list of tasks this task is using ptrace on.</span>
<span class=cm>     * This includes both natural children and PTRACE_ATTACH targets.</span>
<span class=cm>     * p-&gt;ptrace_entry is p&#39;s link on the p-&gt;parent-&gt;ptraced list.</span>
<span class=cm>     */</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>ptraced</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>ptrace_entry</span><span class=p>;</span>

    <span class=cm>/*</span>
<span class=cm>     * This is the tracer handle for the ptrace BTS extension.</span>
<span class=cm>     * This field actually belongs to the ptracer task.</span>
<span class=cm>     */</span>
    <span class=k>struct</span> <span class=nc>bts_context</span> <span class=o>*</span><span class=n>bts</span><span class=p>;</span>

    <span class=cm>/* PID/PID hash table linkage. */</span>
    <span class=k>struct</span> <span class=nc>pid_link</span> <span class=n>pids</span><span class=p>[</span><span class=n>PIDTYPE_MAX</span><span class=p>];</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>thread_group</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>completion</span> <span class=o>*</span><span class=n>vfork_done</span><span class=p>;</span>      <span class=cm>/* for vfork() */</span>
    <span class=kt>int</span> <span class=n>__user</span> <span class=o>*</span><span class=n>set_child_tid</span><span class=p>;</span>      <span class=cm>/* CLONE_CHILD_SETTID */</span>
    <span class=kt>int</span> <span class=n>__user</span> <span class=o>*</span><span class=n>clear_child_tid</span><span class=p>;</span>        <span class=cm>/* CLONE_CHILD_CLEARTID */</span>

    <span class=n>cputime_t</span> <span class=n>utime</span><span class=p>,</span> <span class=n>stime</span><span class=p>,</span> <span class=n>utimescaled</span><span class=p>,</span> <span class=n>stimescaled</span><span class=p>;</span>
    <span class=n>cputime_t</span> <span class=n>gtime</span><span class=p>;</span>
<span class=cp>#ifndef CONFIG_VIRT_CPU_ACCOUNTING</span>
    <span class=n>cputime_t</span> <span class=n>prev_utime</span><span class=p>,</span> <span class=n>prev_stime</span><span class=p>;</span>
<span class=cp>#endif</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>nvcsw</span><span class=p>,</span> <span class=n>nivcsw</span><span class=p>;</span> <span class=cm>/* context switch counts */</span>
    <span class=k>struct</span> <span class=nc>timespec</span> <span class=n>start_time</span><span class=p>;</span>         <span class=cm>/* monotonic time */</span>
    <span class=k>struct</span> <span class=nc>timespec</span> <span class=n>real_start_time</span><span class=p>;</span>    <span class=cm>/* boot based time */</span>

<span class=cm>/* mm fault and swap info: this can arguably be seen as either mm-specific or thread-specific */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>min_flt</span><span class=p>,</span> <span class=n>maj_flt</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>task_cputime</span> <span class=n>cputime_expires</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>cpu_timers</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>

<span class=cm>/* process credentials */</span>
    <span class=k>const</span> <span class=k>struct</span> <span class=nc>cred</span> <span class=o>*</span><span class=n>real_cred</span><span class=p>;</span>   <span class=cm>/* objective and real subjective task</span>
<span class=cm>                     * credentials (COW) */</span>
    <span class=k>const</span> <span class=k>struct</span> <span class=nc>cred</span> <span class=o>*</span><span class=n>cred</span><span class=p>;</span>    <span class=cm>/* effective (overridable) subjective task</span>
<span class=cm>                     * credentials (COW) */</span>
    <span class=k>struct</span> <span class=nc>mutex</span> <span class=n>cred_guard_mutex</span><span class=p>;</span>  <span class=cm>/* guard against foreign influences on</span>
<span class=cm>                     * credential calculations</span>
<span class=cm>                     * (notably. ptrace) */</span>
    <span class=k>struct</span> <span class=nc>cred</span> <span class=o>*</span><span class=n>replacement_session_keyring</span><span class=p>;</span> <span class=cm>/* for KEYCTL_SESSION_TO_PARENT */</span>

    <span class=kt>char</span> <span class=n>comm</span><span class=p>[</span><span class=n>TASK_COMM_LEN</span><span class=p>];</span> <span class=cm>/* executable name excluding path</span>
<span class=cm>                     - access with [gs]et_task_comm (which lock</span>
<span class=cm>                       it with task_lock())</span>
<span class=cm>                     - initialized normally by setup_new_exec */</span>
<span class=cm>/* file system info */</span>
    <span class=kt>int</span> <span class=n>link_count</span><span class=p>,</span> <span class=n>total_link_count</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_SYSVIPC</span>
<span class=cm>/* ipc stuff */</span>
    <span class=k>struct</span> <span class=nc>sysv_sem</span> <span class=n>sysvsem</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_DETECT_HUNG_TASK</span>
<span class=cm>/* hung task detection */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>last_switch_count</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cm>/* CPU-specific state of this task */</span>
    <span class=k>struct</span> <span class=nc>thread_struct</span> <span class=kr>thread</span><span class=p>;</span>
<span class=cm>/* filesystem information */</span>
    <span class=k>struct</span> <span class=nc>fs_struct</span> <span class=o>*</span><span class=n>fs</span><span class=p>;</span>
<span class=cm>/* open file information */</span>
    <span class=k>struct</span> <span class=nc>files_struct</span> <span class=o>*</span><span class=n>files</span><span class=p>;</span>
<span class=cm>/* namespaces */</span>
    <span class=k>struct</span> <span class=nc>nsproxy</span> <span class=o>*</span><span class=n>nsproxy</span><span class=p>;</span>
<span class=cm>/* signal handlers */</span>
    <span class=k>struct</span> <span class=nc>signal_struct</span> <span class=o>*</span><span class=n>signal</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>sighand_struct</span> <span class=o>*</span><span class=n>sighand</span><span class=p>;</span>

    <span class=kt>sigset_t</span> <span class=n>blocked</span><span class=p>,</span> <span class=n>real_blocked</span><span class=p>;</span>
    <span class=kt>sigset_t</span> <span class=n>saved_sigmask</span><span class=p>;</span> <span class=cm>/* restored if set_restore_sigmask() was used */</span>
    <span class=k>struct</span> <span class=nc>sigpending</span> <span class=n>pending</span><span class=p>;</span>

    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>sas_ss_sp</span><span class=p>;</span>
    <span class=kt>size_t</span> <span class=n>sas_ss_size</span><span class=p>;</span>
    <span class=kt>int</span> <span class=p>(</span><span class=o>*</span><span class=n>notifier</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=n>priv</span><span class=p>);</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>notifier_data</span><span class=p>;</span>
    <span class=kt>sigset_t</span> <span class=o>*</span><span class=n>notifier_mask</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>audit_context</span> <span class=o>*</span><span class=n>audit_context</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_AUDITSYSCALL</span>
    <span class=kt>uid_t</span> <span class=n>loginuid</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>sessionid</span><span class=p>;</span>
<span class=cp>#endif</span>
    <span class=n>seccomp_t</span> <span class=n>seccomp</span><span class=p>;</span>

<span class=cm>/* Thread group tracking */</span>
    <span class=n>u32</span> <span class=n>parent_exec_id</span><span class=p>;</span>
    <span class=n>u32</span> <span class=n>self_exec_id</span><span class=p>;</span>
<span class=cm>/* Protection of (de-)allocation: mm, files, fs, tty, keyrings, mems_allowed,</span>
<span class=cm> * mempolicy */</span>
    <span class=n>spinlock_t</span> <span class=n>alloc_lock</span><span class=p>;</span>

<span class=cp>#ifdef CONFIG_GENERIC_HARDIRQS</span>
    <span class=cm>/* IRQ handler threads */</span>
    <span class=k>struct</span> <span class=nc>irqaction</span> <span class=o>*</span><span class=n>irqaction</span><span class=p>;</span>
<span class=cp>#endif</span>

    <span class=cm>/* Protection of the PI data structures: */</span>
    <span class=n>raw_spinlock_t</span> <span class=n>pi_lock</span><span class=p>;</span>

<span class=cp>#ifdef CONFIG_RT_MUTEXES</span>
    <span class=cm>/* PI waiters blocked on a rt_mutex held by this task */</span>
    <span class=k>struct</span> <span class=nc>plist_head</span> <span class=n>pi_waiters</span><span class=p>;</span>
    <span class=cm>/* Deadlock detection and priority inheritance handling */</span>
    <span class=k>struct</span> <span class=nc>rt_mutex_waiter</span> <span class=o>*</span><span class=n>pi_blocked_on</span><span class=p>;</span>
<span class=cp>#endif</span>

<span class=cp>#ifdef CONFIG_DEBUG_MUTEXES</span>
    <span class=cm>/* mutex deadlock detection */</span>
    <span class=k>struct</span> <span class=nc>mutex_waiter</span> <span class=o>*</span><span class=n>blocked_on</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_TRACE_IRQFLAGS</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>irq_events</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>hardirq_enable_ip</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>hardirq_disable_ip</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>hardirq_enable_event</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>hardirq_disable_event</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>hardirqs_enabled</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>hardirq_context</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>softirq_disable_ip</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>softirq_enable_ip</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>softirq_disable_event</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>softirq_enable_event</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>softirqs_enabled</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>softirq_context</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_LOCKDEP</span>
<span class=cp># define MAX_LOCK_DEPTH 48UL</span>
    <span class=n>u64</span> <span class=n>curr_chain_key</span><span class=p>;</span>
    <span class=kt>int</span> <span class=n>lockdep_depth</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>lockdep_recursion</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>held_lock</span> <span class=n>held_locks</span><span class=p>[</span><span class=n>MAX_LOCK_DEPTH</span><span class=p>];</span>
    <span class=n>gfp_t</span> <span class=n>lockdep_reclaim_gfp</span><span class=p>;</span>
<span class=cp>#endif</span>

<span class=cm>/* journalling filesystem info */</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>journal_info</span><span class=p>;</span>

<span class=cm>/* stacked block device info */</span>
    <span class=k>struct</span> <span class=nc>bio_list</span> <span class=o>*</span><span class=n>bio_list</span><span class=p>;</span>

<span class=cm>/* VM state */</span>
    <span class=k>struct</span> <span class=nc>reclaim_state</span> <span class=o>*</span><span class=n>reclaim_state</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>backing_dev_info</span> <span class=o>*</span><span class=n>backing_dev_info</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>io_context</span> <span class=o>*</span><span class=n>io_context</span><span class=p>;</span>

    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>ptrace_message</span><span class=p>;</span>
    <span class=kt>siginfo_t</span> <span class=o>*</span><span class=n>last_siginfo</span><span class=p>;</span> <span class=cm>/* For ptrace use.  */</span>
    <span class=k>struct</span> <span class=nc>task_io_accounting</span> <span class=n>ioac</span><span class=p>;</span>
<span class=cp>#if defined(CONFIG_TASK_XACCT)</span>
    <span class=n>u64</span> <span class=n>acct_rss_mem1</span><span class=p>;</span>  <span class=cm>/* accumulated rss usage */</span>
    <span class=n>u64</span> <span class=n>acct_vm_mem1</span><span class=p>;</span>   <span class=cm>/* accumulated virtual memory usage */</span>
    <span class=n>cputime_t</span> <span class=n>acct_timexpd</span><span class=p>;</span> <span class=cm>/* stime + utime since last update */</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_CPUSETS</span>
    <span class=n>nodemask_t</span> <span class=n>mems_allowed</span><span class=p>;</span>    <span class=cm>/* Protected by alloc_lock */</span>
    <span class=kt>int</span> <span class=n>cpuset_mem_spread_rotor</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_CGROUPS</span>
    <span class=cm>/* Control Group info protected by css_set_lock */</span>
    <span class=k>struct</span> <span class=nc>css_set</span> <span class=o>*</span><span class=n>cgroups</span><span class=p>;</span>
    <span class=cm>/* cg_list protected by css_set_lock and tsk-&gt;alloc_lock */</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>cg_list</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_FUTEX</span>
    <span class=k>struct</span> <span class=nc>robust_list_head</span> <span class=n>__user</span> <span class=o>*</span><span class=n>robust_list</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_COMPAT</span>
    <span class=k>struct</span> <span class=nc>compat_robust_list_head</span> <span class=n>__user</span> <span class=o>*</span><span class=n>compat_robust_list</span><span class=p>;</span>
<span class=cp>#endif</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>pi_state_list</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>futex_pi_state</span> <span class=o>*</span><span class=n>pi_state_cache</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_PERF_EVENTS</span>
    <span class=k>struct</span> <span class=nc>perf_event_context</span> <span class=o>*</span><span class=n>perf_event_ctxp</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>mutex</span> <span class=n>perf_event_mutex</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>list_head</span> <span class=n>perf_event_list</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_NUMA</span>
    <span class=k>struct</span> <span class=nc>mempolicy</span> <span class=o>*</span><span class=n>mempolicy</span><span class=p>;</span>    <span class=cm>/* Protected by alloc_lock */</span>
    <span class=kt>short</span> <span class=n>il_next</span><span class=p>;</span>
<span class=cp>#endif</span>
    <span class=n>atomic_t</span> <span class=n>fs_excl</span><span class=p>;</span>   <span class=cm>/* holding fs exclusive resources */</span>
    <span class=k>struct</span> <span class=nc>rcu_head</span> <span class=n>rcu</span><span class=p>;</span>

    <span class=cm>/*</span>
<span class=cm>     * cache last used pipe for splice</span>
<span class=cm>     */</span>
    <span class=k>struct</span> <span class=nc>pipe_inode_info</span> <span class=o>*</span><span class=n>splice_pipe</span><span class=p>;</span>
<span class=cp>#ifdef  CONFIG_TASK_DELAY_ACCT</span>
    <span class=k>struct</span> <span class=nc>task_delay_info</span> <span class=o>*</span><span class=n>delays</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_FAULT_INJECTION</span>
    <span class=kt>int</span> <span class=n>make_it_fail</span><span class=p>;</span>
<span class=cp>#endif</span>
    <span class=k>struct</span> <span class=nc>prop_local_single</span> <span class=n>dirties</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_LATENCYTOP</span>
    <span class=kt>int</span> <span class=n>latency_record_count</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>latency_record</span> <span class=n>latency_record</span><span class=p>[</span><span class=n>LT_SAVECOUNT</span><span class=p>];</span>
<span class=cp>#endif</span>
    <span class=cm>/*</span>
<span class=cm>     * time slack values; these are used to round up poll() and</span>
<span class=cm>     * select() etc timeout values. These are in nanoseconds.</span>
<span class=cm>     */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>timer_slack_ns</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>default_timer_slack_ns</span><span class=p>;</span>

    <span class=k>struct</span> <span class=nc>list_head</span>    <span class=o>*</span><span class=n>scm_work_list</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_FUNCTION_GRAPH_TRACER</span>
    <span class=cm>/* Index of current stored address in ret_stack */</span>
    <span class=kt>int</span> <span class=n>curr_ret_stack</span><span class=p>;</span>
    <span class=cm>/* Stack of return addresses for return function tracing */</span>
    <span class=k>struct</span> <span class=nc>ftrace_ret_stack</span> <span class=o>*</span><span class=n>ret_stack</span><span class=p>;</span>
    <span class=cm>/* time stamp for last schedule */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>ftrace_timestamp</span><span class=p>;</span>
    <span class=cm>/*</span>
<span class=cm>     * Number of functions that haven&#39;t been traced</span>
<span class=cm>     * because of depth overrun.</span>
<span class=cm>     */</span>
    <span class=n>atomic_t</span> <span class=n>trace_overrun</span><span class=p>;</span>
    <span class=cm>/* Pause for the tracing */</span>
    <span class=n>atomic_t</span> <span class=n>tracing_graph_pause</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef CONFIG_TRACING</span>
    <span class=cm>/* state flags for use by tracers */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>trace</span><span class=p>;</span>
    <span class=cm>/* bitmask of trace recursion */</span>
    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>trace_recursion</span><span class=p>;</span>
<span class=cp>#endif </span><span class=cm>/* CONFIG_TRACING */</span><span class=cp></span>
<span class=cp>#ifdef CONFIG_CGROUP_MEM_RES_CTLR </span><span class=cm>/* memcg uses this to do batch job */</span><span class=cp></span>
    <span class=k>struct</span> <span class=nc>memcg_batch_info</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>do_batch</span><span class=p>;</span>   <span class=cm>/* incremented when batch uncharge started */</span>
        <span class=k>struct</span> <span class=nc>mem_cgroup</span> <span class=o>*</span><span class=n>memcg</span><span class=p>;</span> <span class=cm>/* target memcg of uncharge */</span>
        <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>bytes</span><span class=p>;</span>        <span class=cm>/* uncharged usage */</span>
        <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>memsw_bytes</span><span class=p>;</span> <span class=cm>/* uncharged mem+swap usage */</span>
    <span class=p>}</span> <span class=n>memcg_batch</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=p>};</span>
</code></pre></div></p> <h3 id=2>2 进程描述符的存放<a class=headerlink href=#2 title="Permanent link">&para;</a></h3> <p>Linux通过slab分配器分配task_struct结构，这样能达到对象复用和缓存着色器（cache 、coloring）的目的。在2.6以前的内核中，各个进程的task_struct存放在它们内核栈的尾端。这样做是为了让那些像x86那样寄存器较少的硬件体系结构只要通过栈指针就能计算出它的位置，而避免使用额外的寄存器专门记录。由于现在用slab分配器动态生成task_struct，所以只需在栈底（对于向下增长的栈来说）或栈顶（对于向上增长的栈来说）创建一个新的结构struct <strong>thread_info</strong>。 每个任务的thread_info结构在它的内核的尾端分配。结构中task域中存放的是指向该任务实际task_struct的指针。 在x86上，struct thread_info在文件<asm thread_info.h>中定义（./arch/x86/include/asm/thread_info.h） <div class=highlight><pre><span></span><code><span class=k>struct</span> <span class=nc>thread_info</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=nc>task_struct</span>  <span class=o>*</span><span class=n>task</span><span class=p>;</span>      <span class=cm>/* main task structure */</span>
     <span class=n>bfstruct</span> <span class=n>exec_domain</span>   <span class=o>*</span><span class=n>exec_domain</span><span class=p>;</span>   <span class=cm>/* execution domain */</span>
    <span class=n>__u32</span>           <span class=n>flags</span><span class=p>;</span>      <span class=cm>/* low level flags */</span>
    <span class=n>__u32</span>           <span class=n>status</span><span class=p>;</span>     <span class=cm>/* thread synchronous flags */</span>
    <span class=n>__u32</span>           <span class=n>cpu</span><span class=p>;</span>        <span class=cm>/* current CPU */</span>
    <span class=kt>int</span>         <span class=n>preempt_count</span><span class=p>;</span>  <span class=cm>/* 0 =&gt; preemptable,</span>
<span class=cm>                           &lt;0 =&gt; BUG */</span>
    <span class=n>mm_segment_t</span>        <span class=n>addr_limit</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>restart_block</span>    <span class=n>restart_block</span><span class=p>;</span>
    <span class=kt>void</span> <span class=n>__user</span>     <span class=o>*</span><span class=n>sysenter_return</span><span class=p>;</span>
<span class=cp>#ifdef CONFIG_X86_32</span>
    <span class=kt>unsigned</span> <span class=kt>long</span>           <span class=n>previous_esp</span><span class=p>;</span>   <span class=cm>/* ESP of the previous stack in</span>
<span class=cm>                           case of nested (IRQ) stacks</span>
<span class=cm>                        */</span>
    <span class=n>__u8</span>            <span class=n>supervisor_stack</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
<span class=cp>#endif</span>
    <span class=kt>int</span>         <span class=n>uaccess_err</span><span class=p>;</span>
<span class=p>};</span>
</code></pre></div></p> <p>在内核中，访问任务通常需要获得指向其task_struct的指针； 针对不同的硬件体系结构，获取task_struct的函数或宏有着不同的实现方式； 有的硬件结构可以拿出一个专门的寄存器来存放指向当前进程task_struct的指针，用于加快访问速度。有些像x86这样的体系结构（其寄存器并不富余），就只能在内核栈的尾端创建thread_info结构，通过计算偏移间接地查找task_struct结构。 获取thread_info的函数的C和汇编的实现方式如下（./arch/x86/include/asm/thread_info.h ） <div class=highlight><pre><span></span><code><span class=cm>/* how to get the current stack pointer from C */</span>
<span class=k>register</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>current_stack_pointer</span> <span class=k>asm</span><span class=p>(</span><span class=s>&quot;esp&quot;</span><span class=p>)</span> <span class=n>__used</span><span class=p>;</span>

<span class=cm>/* how to get the thread information struct from C */</span>
<span class=k>static</span> <span class=kr>inline</span> <span class=k>struct</span> <span class=nc>thread_info</span> <span class=o>*</span><span class=n>current_thread_info</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>return</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>thread_info</span> <span class=o>*</span><span class=p>)</span>
        <span class=p>(</span><span class=n>current_stack_pointer</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>THREAD_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div> 假定栈的大小为8KB时，即2^13B，通过屏蔽栈指针的后13个有效位，来计算thread_info的地址;</p> <p>esp为扩展栈指针寄存器，是指针寄存器的一种，用于存放函数栈顶指针。与之对应的是ebp，扩展基址指针寄存器，也被称为帧指针寄存器，用于存放函数栈底指针； 因为esp指向的是当前进程栈空间的某一个函数栈，即通过屏蔽esp的后13个有效位可以获取当前进程栈尾端地址，即可以获得thread_info地址；</p> <p>在分析内核时注意到有些函数会有添加__attribute__((unused))， 在gcc手册中找到了有关的解释： unused：This attribute, attached to a function, means that the function is meant to be possibly unused. GCC will not produce a warning for this function.</p> <p>used： This attribute, attached to a function, means that code must be emitted for the function even if it appears that the function is not referenced. This is useful, for example, when the function is referenced only in inline assembly. 表示该函数或变量可能不使用，这个属性可以避免编译器产生警告信息</p> <p><div class=highlight><pre><span></span><code><span class=cp>#else </span><span class=cm>/* !__ASSEMBLY__ */</span><span class=cp></span>

<span class=cm>/* how to get the thread information struct from ASM */</span>
<span class=cp>#define GET_THREAD_INFO(reg)     \</span>
<span class=cp>    movl $-THREAD_SIZE, reg; \</span>
<span class=cp>    andl %esp, reg</span>

<span class=cm>/* use this one if reg already contains %esp */</span>
<span class=cp>#define GET_THREAD_INFO_WITH_ESP(reg) \</span>
<span class=cp>    andl $-THREAD_SIZE, reg</span>

<span class=cp>#endif</span>
</code></pre></div> 与gcc有关的信息可以查看 <code>./include/linux/compiler-gcc.h</code> 文件</p> <p>相比与x86系统，powerpc系统有足够多的寄存器，而访问进程描述符是一个重要的频繁操作，所以ppc的内核开发者将当前的task_struct保存在一个寄存器中。</p> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../%E8%BF%9B%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> 上一页 </span> 进程生命周期 </div> </div> </a> <a href=../%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 进程状态 </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020-2021 mestarz </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/vendor.18f0862e.min.js></script> <script src=../../assets/javascripts/bundle.994580cf.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs', 'navigation.tabs.sticky', 'search.suggest', 'search.highlight', 'search.share'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src=https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js></script> <script src=../../static/js/extra.js></script> <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>